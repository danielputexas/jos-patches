From 71156fb9964616034757b1428e111d0679274cd2 Mon Sep 17 00:00:00 2001
From: Daniel Parks <danielrparks@utexas.edu>
Date: Wed, 15 Feb 2023 13:16:59 -0600
Subject: [PATCH 2/5] Use modern bochs template

---
 .bochsrc_modern.tmpl | 48 ++++++++++++++++++++++++++++++++++++++++++++
 GNUmakefile          |  8 +++++++-
 2 files changed, 55 insertions(+), 1 deletion(-)
 create mode 100644 .bochsrc_modern.tmpl

diff --git a/.bochsrc_modern.tmpl b/.bochsrc_modern.tmpl
new file mode 100644
index 0000000..5b2ae6c
--- /dev/null
+++ b/.bochsrc_modern.tmpl
@@ -0,0 +1,48 @@
+# configuration file generated by Bochs
+plugin_ctrl: unmapped=1, biosdev=1, speaker=1, extfpuirq=1, parallel=1, serial=1
+config_interface: textconfig
+display_library: x
+memory: host=128, guest=128
+romimage: file="/usr/share/bochs/BIOS-bochs-latest"
+vgaromimage: file="/usr/share/bochs/VGABIOS-lgpl-latest"
+boot: floppy, disk
+floppy_bootsig_check: disabled=0
+# no floppya
+# no floppyb
+ata0: enabled=1, ioaddr1=0x1f0, ioaddr2=0x3f0, irq=14
+ata0-master: type=disk, path="path_to_kernel_img", mode=flat, cylinders=1, heads=1, spt=32, model="Generic 1234", biosdetect=auto, translation=auto
+ata0-slave: type=disk, path="path_to_disk_img", mode=flat, cylinders=1, heads=1, spt=32, model="Generic 1234", biosdetect=auto, translation=auto
+ata1: enabled=1, ioaddr1=0x170, ioaddr2=0x370, irq=15
+ata1-master: type=disk
+ata1-slave: type=disk
+ata2: enabled=0
+ata3: enabled=0
+pci: enabled=1, chipset=i440fx
+vga: extension=vbe, update_freq=5
+cpu: count=1, ips=4000000, model=bx_generic, reset_on_triple_fault=0, cpuid_limit_winnt=0, ignore_bad_msrs=1, mwait_is_nop=0
+cpuid: level=6, stepping=3, model=3, family=6, vendor_string="AuthenticAMD", brand_string="AMD Athlon(tm) processor"
+cpuid: mmx=1, apic=xapic, sse4a=0, misaligned_sse=0, sep=1, movbe=0, adx=0
+cpuid: aes=0, xsave=0, xsaveopt=0, x86_64=1, 1g_pages=0, pcid=0, fsgsbase=0, smep=0
+cpuid: smap=0, mwait=1, vmx=1
+#, svm=0
+print_timestamps: enabled=0
+# no gdb stub
+port_e9_hack: enabled=0
+private_colormap: enabled=0
+clock: sync=none, time0=local, rtc_sync=0
+# no cmosimage
+# no loader
+log: bochs.log
+logprefix: %t%e%d
+debug: action=ignore
+info: action=report
+error: action=report
+panic: action=ask
+keyboard: type=mf, serial_delay=250, paste_delay=100000, user_shortcut=none
+mouse: type=ps2, enabled=0, toggle=ctrl+mbutton
+parport1: enabled=1, file=bochs.out
+parport2: enabled=0
+com1: enabled=1, mode=null, dev=none
+com2: enabled=0
+com3: enabled=0
+com4: enabled=0
diff --git a/GNUmakefile b/GNUmakefile
index 1436856..eda2d1b 100755
--- a/GNUmakefile
+++ b/GNUmakefile
@@ -229,7 +229,13 @@ BOCHS := bochs
 BOCHSOPTS = -q
 BOCHSOPTS += $(BOCHSEXTRA)
 
-bochsrc: .bochsrc.tmpl
+ifeq ($(MODERN),1)
+	BOCHSTMPL := .bochsrc_modern.tmpl
+else
+	BOCHSTMPL := .bochsrc.tmpl
+endif
+
+bochsrc: $(BOCHSTMPL)
 #	BOCHS expects absolute paths
 	$(eval KERN_PATH := $(shell pwd)/$(OBJDIR)/kern/kernel.img)
 	$(eval FS_PATH := $(shell pwd)/$(OBJDIR)/fs/fs.img)
-- 
2.39.1

